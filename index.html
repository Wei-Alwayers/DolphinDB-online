<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Container Manager</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background-color: #eee;
            padding: 10px;
            display: flex;
            justify-content: space-between;
        }

        main {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #containerInfo {
            border: 1px solid #ccc;
            padding: 10px;
            width: 600px;
            height: 20px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
        }

        #embeddedBrowser {
            width: 100%;
            height: 100%;
            border: 1px solid #ccc;
        }
    </style>
</head>

<body>
    <header>
        <div>
            <button id="connectBtn" onclick="connect()">Connect</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
        </div>
        <div id="containerInfo">
            <!-- 这里将显示连接信息 -->
        </div>
    </header>

    <main>
        <div id="embeddedBrowser">
            <!-- 这里将嵌入连接后的网页 -->
        </div>
    </main>

    <script>
        var isConnected = false;
        var currentContainerName = "";

        function connect() {
            if (!isConnected) {
                // 发送连接请求
                fetch("http://localhost:8000/connect", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({}),
                })
                    .then(response => response.json())
                    .then(data => {
                        // 更新右侧显示连接信息的区域
                        document.getElementById("containerInfo").innerHTML = `
                        <Container>Status: Connected ${data.container_name}</p>
                    `;

                        // 更新按钮状态
                        document.getElementById("connectBtn").disabled = true;
                        document.getElementById("disconnectBtn").disabled = false;

                        isConnected = true;
                        currentContainerName = data.container_name;

                        // 延时2秒后嵌入连接后的网页
                        setTimeout(() => {
                            embedBrowser(`http://localhost:${data.port}`);
                        }, 2000);
                    })
                    .catch(error => console.error("连接时发生错误:", error));
            } else {
                alert("已连接到容器，不能创建新的连接。");
            }
        }

        function disconnect() {
            if (isConnected) {
                // 发送断开连接请求
                fetch("http://localhost:8000/disconnect", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ container_name: currentContainerName }),
                })
                    .then(response => response.json())
                    .then(data => {
                        // 更新右侧显示连接信息的区域
                        document.getElementById("containerInfo").innerHTML = `
                        <Container>Status: Disconnected</p>
                    `;

                        // 更新按钮状态
                        document.getElementById("connectBtn").disabled = false;
                        document.getElementById("disconnectBtn").disabled = true;

                        isConnected = false;
                        currentContainerName = "";

                        // 移除嵌入的网页
                        removeEmbeddedBrowser();
                    })
                    .catch(error => console.error("断开连接时发生错误:", error));
            } else {
                alert("未连接到容器，不能断开连接。");
            }
        }

        function embedBrowser(url) {
            // 创建 iframe 元素
            var iframe = document.createElement("iframe");
            iframe.src = url;
            iframe.width = "100%";
            iframe.height = "100%";
            iframe.frameBorder = "0";
            // 将 iframe 插入到指定容器中
            document.getElementById("embeddedBrowser").appendChild(iframe);
        }

        function removeEmbeddedBrowser() {
            // 移除嵌入的网页（清空容器内容）
            document.getElementById("embeddedBrowser").innerHTML = "";
        }

        // 在用户即将离开页面时触发断开连接
        window.addEventListener('beforeunload', function (event) {
            if (isConnected) {
                disconnect();
            }
        });
    </script>
</body>

</html>